<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Trap API: Host communication</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Trap API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('host.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Host communication </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Host communication over the TestTunnel 'host' transport.</p>
<p>file A user application can communicate with the outside world by using the 'host' TestTunnel. This library provides a simple interface for the user application to:</p><ul>
<li>send and receive <a class="el" href="host.html#host_messages">16-bit data in messages</a></li>
<li>send and receive <a class="el" href="host.html#host_streams">8-bit data over Streams</a> (not supported in ADK6)</li>
</ul>
<p>An application which does not use a host transport can use the USB or UART interface directly, using the <a class="el" href="stream_8h.html">stream.h</a> library. The host library is not used in that case.</p>
<p>User-written software on the host based on TestEngine is expected to form the other end of the connection.</p>
<p>See <a class="el" href="host.html">Host communication</a> for more info.</p>
<h1><a class="anchor" id="host_messages"></a>
16-bit data in messages</h1>
<h2><a class="anchor" id="host_message_fmt"></a>
Format of a packet</h2>
<p>The packet format that is used by the VM for communications is very simple, but allows the user to implement a large number of features on top of the simple interface that we provide. The packet begins with one 16-bit word indicating the length of the packet (including the header), followed by a sub-type word. For messages the sub-type can have any value in the range of 0-127 (0x00-0x7f), and is meant to indicate the type of the packet to the code at either end. There are no restrictions on the use of this word, as long as it is within the correct range. The remaining words in the packet can contain any 16-bit data.</p>
<p>Typically the sub-type field is used to multiplex an number of distinct channels between the application and the host.</p>
<p>All packets are held in dynamic memory blocks and the constraints on number and size of these described in the standard library apply to packets.</p>
<table class="doxtable">
<tr>
<td>Length (16bit) </td><td>Sub-type (16bit) </td><td>Data...  </td></tr>
</table>
<p>To receive packets from the host, the application must register a task for #MESSAGE_FROM_HOST using <a class="el" href="group__trapset__host.html#ga96fee19a89278d84a3c5df047191b754" title="Register a task to handle HostComms primitives. ">MessageHostCommsTask()</a>.</p>
<h2><a class="anchor" id="host_message_code"></a>
Example code</h2>
<p>Send a small packet to the host </p><div class="fragment"><div class="line">uint16 *data = <a class="code" href="group__trapset__core.html#gac2cbbcab5783657bfe528a818be2eaa4">PanicUnlessMalloc</a>(3 * <span class="keyword">sizeof</span>(uint16));</div><div class="line">data[0] = 3; <span class="comment">// length</span></div><div class="line">data[1] = 0x7e; <span class="comment">// sub-type</span></div><div class="line">data[2] = 0x1234; <span class="comment">// data</span></div><div class="line"><a class="code" href="group__trapset__host.html#gafc4867fe809327a464eca3c9851f0193">HostSendMessage</a>(data);</div><div class="line">data = NULL; <span class="comment">// we don&#39;t own this block anymore</span></div></div><!-- fragment --><h1><a class="anchor" id="host_streams"></a>
8-bit data over Streams</h1>
<p>There are 256 sources and 256 sinks associated with stream-based host communications; an application might use one for control and one for data.</p>
<p>An application can obtain the source and sink for a particular one of the 256 channels using the StreamHostSource() and <a class="el" href="group__trapset__hoststream.html#gaffd32c6bb78997f1f36ccaf32d42d1bf" title="Get the Sink for the specified stream-based BCSP#13 channel. ">StreamHostSink()</a> functions. The source and sink are then manipulated using the other functions from the <a class="el" href="stream_8h.html">stream.h</a> library.</p>
<h2><a class="anchor" id="host_stream_fmt"></a>
Format of a packet</h2>
<p>The format of a packet is almost identical to that used for messages; this preserves compatibility with existing firmware, at the cost of making the stream-based protocol more complex than strictly necessary.</p>
<p>The packet again begins with one 16-bit word indicating the length of the packet in words (including the header), followed by a sub-type word. The payload follows, with the bytes packed into 16-bit words in low-byte high-byte order and padded out to a 16-bit boundary. That is a payload of 0x01, 0x02, 0x03 will be packed as 0x0201, 0x0003. For streams the sub-type can have any value in the range of 0x100-0x2ff, and encodes both the stream being used and whether the payload includes a padding byte.</p>
<p>The bottom 8-bits of the sub-type word encode the channel for the source or sink. If the top 8-bits are 2 then all of the bytes of the payload are used, if 1 then the top byte of the last word is not part of the payload.</p>
<p>In other words, a consumer might look like: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> incoming(<span class="keyword">const</span> uint16 *packet)</div><div class="line">{</div><div class="line">uint16 words = packet[0];</div><div class="line">uint16 type  = packet[1];</div><div class="line">uint16 chan  = type &amp; 0xff;</div><div class="line">uint16 bytes = (words - 2) * 2 - ((type &gt;&gt; 8) == 1);</div><div class="line">...</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="host_stream_code"></a>
Example code</h2>
<p>Send a 2 byte packet to the host on channel 1 </p><div class="fragment"><div class="line"><a class="code" href="sink___8h.html#a250a23fcb6a29255bb2526a002d691b2">Sink</a> sink = <a class="code" href="group__trapset__core.html#ga5f213a19d903e302c9772792603d7874">PanicNull</a>(<a class="code" href="group__trapset__hoststream.html#gaffd32c6bb78997f1f36ccaf32d42d1bf">StreamHostSink</a>(1));</div><div class="line">uint8 *data = <a class="code" href="group__trapset__stream.html#ga90fa999d02ab67d94ff39f657b979a64">SinkMap</a>(sink) + <a class="code" href="group__trapset__stream.html#gad33984eda4f93d6b4b3402ddf9ada719">SinkClaim</a>(sink, 2);</div><div class="line">data[0] = 0x12;</div><div class="line">data[1] = 0x34;</div><div class="line">PanicZero(<a class="code" href="group__trapset__stream.html#ga4fcdc75c8a60b0d2edb1e0bf92994a03">SinkFlush</a>(sink, 2));</div></div><!-- fragment --><p>Process packets from the host on channel 2 </p><div class="fragment"><div class="line">uint16 size;</div><div class="line"><a class="code" href="source___8h.html#afbe187e42995c6b6af38624c70e7a3e2">Source</a> source = StreamHostSource(2);</div><div class="line"><span class="keywordflow">while</span> ((size = <a class="code" href="group__trapset__stream.html#gaf671f63da2440f82542e8444cdfb199e">SourceBoundary</a>(source)) != 0)</div><div class="line">{</div><div class="line"><span class="keyword">const</span> uint8 *data = <a class="code" href="group__trapset__stream.html#ga6d643b195dfdb398d0c0d2d8ab9d4ec5">SourceMap</a>(source);</div><div class="line"><span class="comment">// do something with the data here</span></div><div class="line"><a class="code" href="group__trapset__stream.html#gae56caaf5efeee75f7d7f0cd49f2b7f4f">SourceDrop</a>(source, size);</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="host_issues"></a>
Related Issues</h1>
<h2><a class="anchor" id="host_limitations"></a>
Limitations</h2>
<p>All packets must fit in an available on-chip memory block and as such are restricted to around 80 words in total. This restriction applies even to stream-based messages.</p>
<p>If a packet arrives for a source and insufficient space is available, the message will be silently discarded. Users can expect to have at most 200 bytes of data held in any source associated with host communications.</p>
<h2><a class="anchor" id="host_coex"></a>
Coexistence</h2>
<p>Both message and stream based host communications can be used in the same application as required; the second word of a data message is used to distinguish between the two formats.</p>
<p>Which is more appropriate depends on your application: streams are designed for 8-bit data, while messages are more suited to packed binary data such as structures. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
